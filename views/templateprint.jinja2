{% extends "base.jinja2" %}

{% block page_title %}{{ title }}{% endblock %}

{% block jumbotron %}
  <h1>Template File Print</h1>
  <p>Select your template and print it.</p>
  <!--<p><a class="btn btn-primary btn-lg" href="#" role="button">History of printed labels</a></p>-->
{% endblock %}

{% block content %}
<div class="row">
<div class="col-md-4">
    <fieldset class="form-group">
        <div class="panel-group" id="accordion">
          <div class="panel panel-default">
              <div class="panel-heading">
                  <h4 class="panel-title">
                      <a data-toggle="collapse" data-parent="#accordion" href="#collapse0">
                          <span class="glyphicon glyphicon-print"></span> Template File</a>
                  </h4>
              </div>
              <div id="collapse0" class="panel-collapse collapse in" aria-expanded="true">
                  <div class="chooser panel-body">
                      <label for="template"> Template:</label>
                      <select class="form-control" id="template" onChange="onTemplateChange()">
                          <option value="">Select a template...</option>
                          {% for template in files %}<option value="{{template}}">{{template }}</option>{% endfor %}
                      </select>
                      <label for="quantity" >Quantity:</label>
                      <input id="quantity" class="form-control" type="number" min="1" value="1" required>
                  </div> <!-- class="chooser panel-body" -->
              </div>
          </div>

          <!-- Dynamic Form Fields Panel -->
          <div class="panel panel-default" id="dynamicFieldsPanel" style="display: none;">
              <div class="panel-heading">
                  <h4 class="panel-title">
                      <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">
                          <span class="glyphicon glyphicon-edit"></span> Template Data</a>
                  </h4>
              </div>
              <div id="collapse1" class="panel-collapse collapse in" aria-expanded="true">
                  <div class="panel-body">
                      <div id="dynamicFields">
                          <!-- Dynamic form fields will be inserted here -->
                      </div>
                  </div>
              </div>
          </div>
        </div>
    </fieldset>
</div>
    <div class="col-md-4">
      <fieldset class="form-group">
        <label for="previewImg">Label Preview:</label><br />
        <img id="previewImg" alt="Label preview" style="border: 1px solid #444; max-height: 350px; width: auto; max-width: 100%; margin-bottom: 10px;"/>
        <p>Printed size w/o margins: <span id="labelWidth">?</span> cm x <span id="labelHeight">?</span> cm</p>
        <button id="printButton" type="button" class="btn btn-primary btn-block btn-lg" onClick="print()" disabled>
          <span class="glyphicon glyphicon-print" aria-hidden="true"></span> Print
        </button>
      </fieldset>
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title"><span class="glyphicon glyphicon-console" aria-hidden="true" style="margin-right: 0.3em"></span> Status</h3>
        </div>
        <div id="statusPanel" class="panel-body">
          - undefined -
        </div>
      </div>
</div>
{% endblock %}

{% block javascript %}

var currentTemplateFields = [];

function formData() {
  var data = {
    quantity: parseInt($('#quantity').val()) || 1
  };

  // Add dynamic field values
  currentTemplateFields.forEach(function(field) {
    var value = $('#field_' + field.name).val();
    // Always submit required fields, even if empty
    if (field.required) {
      data[field.name] = value !== undefined && value !== null ? value : '';
    } else if (value) {
      data[field.name] = value;
    }
  });

  return data;
}

function onTemplateChange() {
  var templateName = $('#template').val();
  if (!templateName) {
    $('#dynamicFieldsPanel').hide();
    $('#previewImg').attr('src', '');
    $('#printButton').prop('disabled', true);
    return;
  }

  loadTemplateFields(templateName);
  // Don't call preview() here - it will be called after fields are loaded
}

function loadTemplateFields(templateName) {
  $.ajax({
    url: '/api/template/' + templateName + '/fields',
    type: 'GET',
    dataType: 'json',
    success: function(response) {
      currentTemplateFields = response.fields || [];
      generateDynamicFields(currentTemplateFields);
      $('#printButton').prop('disabled', currentTemplateFields.length > 0);
      // Call preview() after fields are successfully loaded
      preview();
    },
    error: function(xhr, status, error) {
      console.error('Error loading template fields:', error);
      $('#dynamicFieldsPanel').hide();
      currentTemplateFields = [];
      $('#printButton').prop('disabled', false);
      // Still try to load preview even if fields loading fails
      preview();
    }
  });
}

function generateDynamicFields(fields) {
  var fieldsContainer = $('#dynamicFields');
  fieldsContainer.empty();

  if (fields.length === 0) {
    $('#dynamicFieldsPanel').hide();
    $('#printButton').prop('disabled', false);
    return;
  }

  $('#dynamicFieldsPanel').show();

  fields.forEach(function(field) {
    var fieldHtml = '<div class="form-group">';
    fieldHtml += '<label for="field_' + field.name + '">' + field.label;
    if (field.required) {
      fieldHtml += ' <span class="text-danger">*</span>';
    }
    fieldHtml += ':</label>';

    var inputType = field.type || 'text';
    var placeholder = field.placeholder || '';

    if (inputType === 'textarea') {
      fieldHtml += '<textarea class="form-control" id="field_' + field.name + '" name="' + field.name + '"';
      if (field.required) fieldHtml += ' required';
      fieldHtml += ' placeholder="' + placeholder + '" onchange="onFieldChange()" onkeyup="onFieldChange()"></textarea>';
    } else {
      fieldHtml += '<input type="' + inputType + '" class="form-control" id="field_' + field.name + '" name="' + field.name + '"';
      if (field.required) fieldHtml += ' required';
      fieldHtml += ' placeholder="' + placeholder + '" onchange="onFieldChange()" onkeyup="onFieldChange()">';
    }

    if (field.description) {
      fieldHtml += '<small class="form-text text-muted">' + field.description + '</small>';
    }

    fieldHtml += '</div>';

    fieldsContainer.append(fieldHtml);
  });

  // Enable/disable print button based on required fields
  updatePrintButtonState();
}

function onFieldChange() {
  updatePrintButtonState();
  // Update preview when fields change
  clearTimeout(window.previewTimeout);
  window.previewTimeout = setTimeout(preview, 300); // Debounce preview updates
}

function updatePrintButtonState() {
  var allRequiredFieldsFilled = true;

  currentTemplateFields.forEach(function(field) {
    if (field.required) {
      var value = $('#field_' + field.name).val();
      if (!value || value.trim() === '') {
        allRequiredFieldsFilled = false;
      }
    }
  });

  $('#printButton').prop('disabled', !allRequiredFieldsFilled);
}

function preview() {
  var templateName = $('#template').val();
  if (!templateName) return;

  var formDataObj = formData();
  var url = '/api/preview/template/' + templateName;

  // Separate regular form data from JSON payload fields
  var regularData = {};
  var jsonPayload = {};

  currentTemplateFields.forEach(function(field) {
    var value = $('#field_' + field.name).val();
    // Always submit required fields, even if empty
    if (field.required) {
      var fieldValue = value !== undefined && value !== null ? value : '';
      if (field.json_payload) {
        jsonPayload[field.name] = fieldValue;
      } else {
        regularData[field.name] = fieldValue;
      }
    } else if (value) {
      // Only submit non-required fields if they have a value
      if (field.json_payload) {
        jsonPayload[field.name] = value;
      } else {
        regularData[field.name] = value;
      }
    }
  });

  // Add quantity to regular data
  regularData.quantity = formDataObj.quantity;

  // Build query string for regular form data
  var queryParams = [];
  for (var key in regularData) {
      queryParams.push(encodeURIComponent(key) + '=' + encodeURIComponent(regularData[key]));
  }

  if (queryParams.length > 0) {
    url += '?' + queryParams.join('&');
  }

  // Use POST request with JSON payload
  $.ajax({
    url: url,
    type: 'POST',
    data: JSON.stringify(jsonPayload),
    contentType: 'application/json',
    xhrFields: {
      responseType: 'blob'
    },
    success: function(imageData) {
      var imageUrl = URL.createObjectURL(imageData);
      $('#previewImg').attr('src', imageUrl);
      var img = $('#previewImg')[0];
      img.onload = function() {
        $('#labelWidth').html((img.naturalWidth / 300 * 2.54).toFixed(1));
        $('#labelHeight').html((img.naturalHeight / 300 * 2.54).toFixed(1));
        URL.revokeObjectURL(imageUrl);
      };
    },
    error: function(xhr, status, error) {
      console.error('Error loading preview:', error);
      // Fallback to GET request
      $('#previewImg').attr('src', url);
      var img = $('#previewImg')[0];
      img.onload = function() {
        $('#labelWidth').html((img.naturalWidth / 300 * 2.54).toFixed(1));
        $('#labelHeight').html((img.naturalHeight / 300 * 2.54).toFixed(1));
      };
    }
  });
}

function setStatus(data) {
  if (data['success'])
    $('#statusPanel').html('<div id="statusBox" class="alert alert-success" role="alert"><i class="glyphicon glyphicon-check"></i><span>Printing was successful.</span></div>');
  else
    $('#statusPanel').html('<div id="statusBox" class="alert alert-warning" role="alert"><i class="glyphicon glyphicon-alert"></i><span>Printing was unsuccessful:<br />'+data['message']+'</span></div>');
  $('#printButton').prop('disabled', false);
  updatePrintButtonState(); // Restore proper button state
}

function print() {
  $('#printButton').prop('disabled', true);
  $('#statusPanel').html('<div id="statusBox" class="alert alert-info" role="alert"><i class="glyphicon glyphicon-hourglass"></i><span>Processing print request...</span></div>');
  urlstring = '/api/print/template/' + $('#template').val();
  $.ajax({
    type:     'POST',
    dataType: 'json',
    data:     formData(),
    url:      urlstring,
    success:  setStatus,
    error:    setStatus
  });
}

{% endblock %}