{% extends "base.jinja2" %}

{% block page_title %}{{ title }}{% endblock %}

{% block jumbotron %}
    <h1>Template Designer</h1>
    <p>Design a template file for printing.</p>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-4">
            <fieldset class="form-group">
                <div class="panel-group" id="accordion">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion" href="#collapse0">
                                    <span class="glyphicon glyphicon-print"></span> Template File</a>
                            </h4>
                        </div>
                        <div id="collapse0" class="panel-collapse collapse in" aria-expanded="true">
                            <div class="chooser panel-body">
                                <label for="template"> Template:</label>
                                <select class="form-control" id="template" onChange="preview()">
                                    <option value="NEW_FILE">&lt;New File&gt;</option>
                                    {% for template in files %}<option value="{{ template }}">{{ template }}</option>{% endfor %}
                                </select>
                                <div id="newFileName">
                                    <br/>
                                    <label for="newFileNameField" id="newFileNameLabel">New File Name:</label>
                                    <input class="form-control" id="newFileNameField" type="text"/>
                                </div>
                                <br/>
                                <button id="loadFileButton" type="button" class="btn btn-primary btn-block btn-lg" onClick="load_file()">
                                    <span class="glyphicon glyphicon-file" aria-hidden="true"></span> Load
                                </button>
                            </div> <!-- class="chooser panel-body" -->
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">
                                    <span class="glyphicon glyphicon-file" aria-hidden="true"></span> Label
                                    Size</a>
                            </h4>
                        </div>
                        <div id="collapse1" class="panel-collapse collapse">
                            <div class="chooser panel-body">
                                <label for="labelSize" style="display: none">Label Size:</label>
                                <select class="form-control" id="labelSize" onChange="preview()">
                                    {% for label_size in label_sizes.keys() %}
                                        <option value="{{ label_size }}"
                                                {% if label['DEFAULT_SIZE'] == label_size %}selected{% endif %}>{{ label_sizes[label_size] }}</option>{% endfor %}
                                </select>
                                <label for="orientation" style="margin-top: 10px; margin-bottom: 0">Label
                                    Orientation:</label>
                                <div class="radio" style="margin-top: 5px;">
                                    <label><input type="radio" onchange="preview()" name="orientation"
                                                  value="standard"
                                                  {% if default_orientation == 'standard' %}checked{% endif %}>Standard</label>
                                </div>
                                <div class="radio">
                                    <label><input type="radio" onchange="preview()" name="orientation"
                                                  value="rotated"
                                                  {% if default_orientation == 'rotated' %}checked{% endif %}>Rotated</label>
                                </div>
                            </div> <!-- class="chooser panel-body" -->
                        </div>
                    </div>
                </div>
            </fieldset>
        </div>
{#        <div class="col-md-4">#}
{#            <div class="form-group">#}
{#                <div id='editor_holder'></div>#}
{#            </div>#}
{#        </div>#}
        <div class="col-md-4">
            <fieldset class="form-group">
                <label for="previewImg">Label Preview:</label><br/>
                <img id="previewImg"
                     style="border: 1px solid #444; max-height: 350px; width: auto; max-width: 100%; margin-bottom: 10px;"/>
                <p>Printed size w/o margins: <span id="labelWidth">?</span> cm x <span id="labelHeight">?</span> cm</p>
                {#                <button id="printButton" type="button" class="btn btn-primary btn-block btn-lg" onClick="print()">#}
                {#                    <span class="glyphicon glyphicon-print" aria-hidden="true"></span> Print#}
                {#                </button>#}
            </fieldset>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="glyphicon glyphicon-console" aria-hidden="true"
                                                  style="margin-right: 0.3em"></span> Status</h3>
                </div>
                <div id="statusPanel" class="panel-body">
                    - undefined -
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="form-group">
            <div id='editor_holder'></div>
        </div>
    </div>
{% endblock %}

{% block extrajavascript %}
    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>

        <script>

    var editor = new JSONEditor(document.getElementById('editor_holder'),{
        schema: {
            title: "Label Template",
            $ref: "#/definitions/label",
            definitions: {
                label: {
                    type: "object",
                    id: "label",
                    // The object will start with only these properties
                    defaultProperties: [
                        "name",
                        "elements"
                    ],
                    properties: {
                        name: {
                            title: "Description",
                            type: "string",
                            description: "Description of the label",
                        },
                        width: {
                            title: "Width",
                            type: "integer",
                            minimum: 1,
                            default: 300
                        },
                        height: {
                            title: "Height",
                            type: "integer",
                            minimum: 1,
                            default: 100
                        },
                        elements: {
                            type: "array",
                            title: "Elements",
                            items: {
                                title: "Element",
                                anyOf: [
                                    {
                                        title: "none",
                                        type: "null"
                                    }
                                    {% for definition in element_definitions.keys() %}
                                    ,{
                                        title: "{{definition}}",
                                        $ref: "#/definitions/{{definition}}"
                                    }
                                    {% endfor %}
                                ]
                            }
                        },
                    }
                }
                {% for definition in element_definitions.keys() %},
                {{ definition }}: {{ element_definitions[definition]}}
                {% endfor %}
            }
        },
        theme: 'bootstrap3',
        no_additional_properties: true,
        disable_edit_json: false,
        object_layout: 'grid'
      });

        function formData() {
            return {
                printer: $('#printer').val(),
                quantity: $('#quantity').val()
            }
        }

        function preview() {
            var templateVal = $('#template').val();

            if(templateVal == "NEW_FILE"){
                $('#loadFileButton').prop("value","Save");
                $('#newFileName').show();
                $('#newFileNameLabel').show();
                return
            }

            $('#newFileName').hide();
            $('#newFileNameLabel').hide();
            $('#loadFileButton').prop("value","Load");

            url = '/api/preview/template/' + templateVal;
            $('#previewImg').attr('src', url);
            var img = $('#previewImg')[0];
            img.onload = function () {
                $('#labelWidth').html((img.naturalWidth / 300 * 2.54).toFixed(1));
                $('#labelHeight').html((img.naturalHeight / 300 * 2.54).toFixed(1));
            };
        }

        function setStatus(data) {
            if (data['success'])
                $('#statusPanel').html('<div id="statusBox" class="alert alert-success" role="alert"><i class="glyphicon glyphicon-check"></i><span>Printing was successful.</span></div>');
            else
                $('#statusPanel').html('<div id="statusBox" class="alert alert-warning" role="alert"><i class="glyphicon glyphicon-alert"></i><span>Printing was unsuccessful:<br/>' + data['message'] + '</span></div>');
            $('#printButton').prop('disabled', false);
        }

        function load_file(){

        }

        preview()
    </script>

{% endblock %}

{% block javascript %}


{% endblock %}
