{% extends "base.jinja2" %}

{% block jumbotron %}
  <h1>{{ website['PAGE_TITLE'] }}</h1>
  <p>Application Settings</p>
{% endblock %}

{% block content %}
  <div class="container">
    <div class="row">
      <div class="col-md-10 col-md-offset-1">

        <!-- Configuration Errors Alert -->
        {% if has_errors %}
        <div class="alert alert-danger" role="alert">
          <h4 class="alert-heading">
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
            Configuration Errors
          </h4>
          <p>The application has encountered the following configuration errors:</p>
          <div id="errorsList" style="margin-top: 10px;">
            <!-- Errors will be loaded here via JavaScript -->
          </div>
          <hr>
          <p class="mb-0">Please review and fix the errors below before the application can work properly.</p>
        </div>
        {% endif %}

        <!-- Unsaved Changes Indicator (Fixed Position) -->
        <div id="unsavedIndicator" style="display: none; position: fixed; top: 60px; right: 20px; z-index: 1000; background-color: #f0ad4e; color: white; padding: 12px 20px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
          <span class="glyphicon glyphicon-warning-sign" aria-hidden="true"></span>
          <strong>Unsaved Changes</strong> - Click Save to apply changes
        </div>

        <!-- Action Buttons (Top) -->
        <div style="margin-bottom: 20px;">
          <button id="saveButton" class="btn btn-primary btn-lg">
            <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Save All Settings
          </button>
          <button id="resetButton" class="btn btn-default btn-lg">
            <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> Reload Settings
          </button>
          <div id="statusMessage" style="display: inline-block; margin-left: 20px;"></div>
        </div>

        <!-- Settings Accordion -->
        <div class="panel-group" id="settingsAccordion" role="tablist">

          <!-- SERVER Configuration -->
          <div class="panel panel-primary">
            <div class="panel-heading" role="tab" id="headingServer">
              <h4 class="panel-title">
                <a role="button" data-toggle="collapse" data-parent="#settingsAccordion" href="#collapseServer" aria-expanded="false">
                  <span class="glyphicon glyphicon-hdd" aria-hidden="true"></span> Server Configuration
                </a>
              </h4>
            </div>
            <div id="collapseServer" class="panel-collapse collapse" role="tabpanel">
              <div class="panel-body">
                <div class="form-horizontal">
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Host Address</label>
                    <div class="col-sm-9">
                      <input type="text" class="form-control" id="serverHost" placeholder="0.0.0.0 or leave empty">
                      <p class="help-block">The network address the server listens on. Use 0.0.0.0 for all interfaces, 127.0.0.1 for local only, or empty string.</p>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Log Level</label>
                    <div class="col-sm-9">
                      <select class="form-control" id="serverLogLevel">
                        <option value="DEBUG">DEBUG</option>
                        <option value="INFO">INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                        <option value="CRITICAL">CRITICAL</option>
                      </select>
                      <p class="help-block">Application logging level. DEBUG shows the most information, CRITICAL shows only severe errors.</p>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Additional Font Folder</label>
                    <div class="col-sm-9">
                      <input type="text" class="form-control" id="serverFontFolder" placeholder="/path/to/fonts or false">
                      <p class="help-block">Path to additional font folder, or 'false' to disable. TTF and OTF fonts in this folder will be available.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- PRINTER Configuration -->
          <div class="panel panel-info">
            <div class="panel-heading" role="tab" id="headingPrinter">
              <h4 class="panel-title">
                <a role="button" data-toggle="collapse" data-parent="#settingsAccordion" href="#collapsePrinter" aria-expanded="true">
                  <span class="glyphicon glyphicon-print" aria-hidden="true"></span> Printer Configuration
                </a>
              </h4>
            </div>
            <div id="collapsePrinter" class="panel-collapse collapse in" role="tabpanel">
              <div class="panel-body">
                <div class="form-horizontal">
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Use CUPS</label>
                    <div class="col-sm-9">
                      <div class="checkbox" style="margin-bottom:10px;">
                        <label>
                          <input type="checkbox" id="printerUseCups"> Enable CUPS for media retrieval
                        </label>
                      </div>
                      <button id="reloadMediaBtn" class="btn btn-sm btn-info" type="button">
                        <span class="glyphicon glyphicon-repeat" aria-hidden="true"></span> Reload media sizes from CUPS
                      </button>
                      <div id="cups-status" class="alert alert-info" style="margin-top: 10px;">
                        Loading CUPS status...
                      </div>
                    </div>
                  </div>

                  <div class="form-group">
                    <label class="col-sm-3 control-label">CUPS Server</label>
                    <div class="col-sm-9">
                      <div class="input-group">
                        <input type="text" class="form-control" id="printerServer" placeholder="localhost">
                        <span class="input-group-btn">
                          <button id="validateCupsBtn" class="btn btn-default" type="button">
                            <span class="glyphicon glyphicon-ok-circle" aria-hidden="true"></span> Validate
                          </button>
                        </span>
                      </div>
                      <p class="help-block">CUPS server address. Use 'localhost' for local CUPS, or IP address for remote.</p>
                      <div id="cupsValidateStatus" class="text-muted" style="margin-top:5px;"></div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Default Printer</label>
                    <div class="col-sm-9">
                      <select class="form-control" id="printerName">
                        <option value="">(CUPS Default)</option>
                      </select>
                      <p class="help-block">Default printer to use. Select "CUPS Default" to use the CUPS default printer.</p>
                    </div>
                  </div>

                  <div class="form-group">
                    <label class="col-sm-3 control-label">Printer Include List</label>
                    <div class="col-sm-9">
                      <p class="help-block" style="margin-top: 0;">If any printers are selected, show only those printers. Leave all unchecked to include all.</p>
                      <div id="printersIncludeList" class="well well-sm" style="max-height: 200px; overflow-y: auto;">
                        <p class="text-muted">Loading printers...</p>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Printer Exclude List</label>
                    <div class="col-sm-9">
                      <p class="help-block" style="margin-top: 0;">Printers to hide from lists. Applied after include list.</p>
                      <div id="printersExcludeList" class="well well-sm" style="max-height: 200px; overflow-y: auto;">
                        <p class="text-muted">Loading printers...</p>
                      </div>
                    </div>
                  </div>

                  <hr>
                  <h5><strong>Custom Media Sizes (global)</strong></h5>
                  <p class="text-muted small">Add custom size key and display label. "Custom." will be automatically prepended to the key.</p>
                  <div class="form-inline" style="margin-bottom:10px;">
                    <input type="text" class="form-control" id="customSizeKey" placeholder="size key (e.g., 100x150mm)" style="width:40%; margin-right:5px;">
                    <input type="text" class="form-control" id="customSizeLabel" placeholder="Display label (e.g., 4in x 6in)" style="width:40%; margin-right:5px;">
                    <button id="addCustomSizeBtn" type="button" class="btn btn-default">
                      <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Add
                    </button>
                  </div>
                  <div id="customSizesList" class="list-group" style="margin-bottom: 15px;"></div>

                  <!-- Edit custom size modal form -->
                  <div id="editSizeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
                    <div style="position:relative; margin:100px auto; max-width:500px; background:white; padding:20px; border-radius:5px;">
                      <h4>Edit Custom Size</h4>
                      <div class="form-group">
                        <label>Size Key</label>
                        <input type="text" class="form-control" id="editSizeKey" readonly>
                      </div>
                      <div class="form-group">
                        <label>Display Label</label>
                        <input type="text" class="form-control" id="editSizeLabel">
                      </div>
                      <button class="btn btn-primary" onclick="saveEditedSize()">Save</button>
                      <button class="btn btn-default" onclick="closeEditModal()">Cancel</button>
                    </div>
                  </div>

                  <hr>
                  <h5><strong>Enabled Media Sizes Per Printer</strong></h5>
                  <p class="text-muted small">Select media sizes that should be enabled for each printer. All other sizes will be disabled by default.</p>
                  <div id="printers-container">
                    <p class="text-muted">Loading printers...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- LABEL Configuration -->
          <div class="panel panel-success">
            <div class="panel-heading" role="tab" id="headingLabel">
              <h4 class="panel-title">
                <a role="button" data-toggle="collapse" data-parent="#settingsAccordion" href="#collapseLabel" aria-expanded="false">
                  <span class="glyphicon glyphicon-tag" aria-hidden="true"></span> Label Configuration
                </a>
              </h4>
            </div>
            <div id="collapseLabel" class="panel-collapse collapse" role="tabpanel">
              <div class="panel-body">
                <div class="form-horizontal">
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Default Label Size</label>
                    <div class="col-sm-9">
                      <select class="form-control" id="labelDefaultSize">
                        <option value="">Loading...</option>
                      </select>
                      <p class="help-block">Default label size for the default printer. Only enabled sizes are shown.</p>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Default Orientation</label>
                    <div class="col-sm-9">
                      <select class="form-control" id="labelDefaultOrientation">
                        <option value="standard">Standard</option>
                        <option value="rotated">Rotated</option>
                      </select>
                      <p class="help-block">Default label orientation. Rotated turns the label 90 degrees.</p>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Default Font Size</label>
                    <div class="col-sm-9">
                      <input type="number" class="form-control" id="labelDefaultFontSize" min="8" max="500" placeholder="70">
                      <p class="help-block">Default font size in points.</p>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Default Font Family</label>
                    <div class="col-sm-9">
                      <select class="form-control" id="labelDefaultFontFamily">
                        <option value="">Loading...</option>
                      </select>
                      <p class="help-block">Default font family name.</p>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Default Font Style</label>
                    <div class="col-sm-9">
                      <select class="form-control" id="labelDefaultFontStyle">
                        <option value="">Loading...</option>
                      </select>
                      <p class="help-block">Default font style (e.g., Book, Bold, Italic).</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- WEBSITE Configuration -->
          <div class="panel panel-warning">
            <div class="panel-heading" role="tab" id="headingWebsite">
              <h4 class="panel-title">
                <a role="button" data-toggle="collapse" data-parent="#settingsAccordion" href="#collapseWebsite" aria-expanded="false">
                  <span class="glyphicon glyphicon-globe" aria-hidden="true"></span> Website Configuration
                </a>
              </h4>
            </div>
            <div id="collapseWebsite" class="panel-collapse collapse" role="tabpanel">
              <div class="panel-body">
                <div class="form-horizontal">
                  <div class="form-group">
                    <label class="col-sm-3 control-label">HTML Title</label>
                    <div class="col-sm-9">
                      <input type="text" class="form-control" id="websiteHtmlTitle" placeholder="Label Designer">
                      <p class="help-block">Title shown in browser tab and bookmarks.</p>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Page Title</label>
                    <div class="col-sm-9">
                      <input type="text" class="form-control" id="websitePageTitle" placeholder="Label Designer">
                      <p class="help-block">Title shown in the navigation bar.</p>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Page Headline</label>
                    <div class="col-sm-9">
                      <input type="text" class="form-control" id="websitePageHeadline" placeholder="Design and print labels">
                      <p class="help-block">Headline shown on the home page jumbotron.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Action Buttons (Bottom) -->
        <div style="margin-top: 20px; margin-bottom: 40px;">
          <button id="saveButton2" class="btn btn-primary btn-lg">
            <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Save All Settings
          </button>
          <button id="resetButton2" class="btn btn-default btn-lg">
            <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> Reload Settings
          </button>
        </div>

      </div>
    </div>
  </div>

  <script>
    // Store the settings state
    let settingsState = {
      server: { host: '', logLevel: 'INFO', additionalFontFolder: false },
      printer: {
        useCups: false,
        server: 'localhost',
        printer: '',
        enabledSizes: {},   // { printer_name: [size1, ...] }
        labelSizes: {},     // global custom sizes map
        printersInclude: [],
        printersExclude: []
      },
      label: { defaultSize: '', defaultOrientation: 'standard', defaultFontSize: 70, defaultFontFamily: 'DejaVu Sans', defaultFontStyle: 'Book' },
      website: { htmlTitle: 'Label Designer', pageTitle: 'Label Designer', pageHeadline: 'Design and print labels' }
    };

    let hasUnsavedChanges = false;
    let originalSettingsJson = '';
    let availableFonts = {}; // { family: [style1, style2, ...] }
    let availableLabelSizes = {}; // { size_key: size_label }

    function markAsChanged() {
      hasUnsavedChanges = true;
      document.getElementById('unsavedIndicator').style.display = 'block';
    }

    function markAsSaved() {
      hasUnsavedChanges = false;
      document.getElementById('unsavedIndicator').style.display = 'none';
      // Update the baseline for comparison
      originalSettingsJson = JSON.stringify(settingsState);
    }

    function loadSettings() {
      fetch('/api/settings')
        .then(r => r.json())
        .then(data => {
          settingsState = data;
          renderSettings();
          markAsSaved(); // Reset unsaved indicator after loading
          showStatus('Settings loaded successfully', 'success');
        })
        .catch(err => { console.error(err); showStatus('Failed to load settings: ' + err, 'danger'); });
    }

    function loadFonts() {
      fetch('/api/settings/fonts')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            availableFonts = data.fonts;
            populateFontFamilyDropdown();
          }
        })
        .catch(err => { console.error('Error loading fonts:', err); });
    }

    function loadLabelSizes() {
      // Get the current default printer to load its enabled sizes
      const defaultPrinter = settingsState.printer.printer || '';
      const url = `/api/printer/${encodeURIComponent(defaultPrinter || 'null')}/media`;

      fetch(url)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            availableLabelSizes = data.label_sizes;
            populateLabelSizeDropdown();
          }
        })
        .catch(err => { console.error('Error loading label sizes:', err); });
    }

    function populateFontFamilyDropdown() {
      const select = document.getElementById('labelDefaultFontFamily');
      const currentFamily = settingsState.label.defaultFontFamily || '';

      let html = '<option value="">-- Select Font Family --</option>';
      const families = Object.keys(availableFonts).sort();
      families.forEach(family => {
        const selected = family === currentFamily ? 'selected' : '';
        html += `<option value="${escapeHtmlAttr(family)}" ${selected}>${escapeHtml(family)}</option>`;
      });

      select.innerHTML = html;

      // Populate styles for current family
      populateFontStyleDropdown();
    }

    function populateFontStyleDropdown() {
      const select = document.getElementById('labelDefaultFontStyle');
      const currentFamily = document.getElementById('labelDefaultFontFamily').value;
      const currentStyle = settingsState.label.defaultFontStyle || '';

      if (!currentFamily || !availableFonts[currentFamily]) {
        select.innerHTML = '<option value="">-- Select Font Family First --</option>';
        return;
      }

      let html = '<option value="">-- Select Font Style --</option>';
      const styles = availableFonts[currentFamily].sort();
      styles.forEach(style => {
        const selected = style === currentStyle ? 'selected' : '';
        html += `<option value="${escapeHtmlAttr(style)}" ${selected}>${escapeHtml(style)}</option>`;
      });

      select.innerHTML = html;
    }

    function populateLabelSizeDropdown() {
      const select = document.getElementById('labelDefaultSize');
      const currentSize = settingsState.label.defaultSize || '';

      let html = '<option value="">-- Select Label Size --</option>';
      const entries = Object.entries(availableLabelSizes);
      entries.forEach(([key, label]) => {
        const selected = key === currentSize ? 'selected' : '';
        html += `<option value="${escapeHtmlAttr(key)}" ${selected}>${escapeHtml(label)}</option>`;
      });

      select.innerHTML = html;
    }

    // Listen for font family changes to update styles dropdown
    document.addEventListener('DOMContentLoaded', function() {
      const fontFamilySelect = document.getElementById('labelDefaultFontFamily');
      if (fontFamilySelect) {
        fontFamilySelect.addEventListener('change', function() {
          populateFontStyleDropdown();
          markAsChanged();
        });
      }

      // Listen for default printer changes to update label sizes
      const printerSelect = document.getElementById('printerName');
      if (printerSelect) {
        printerSelect.addEventListener('change', function() {
          loadLabelSizes();
          markAsChanged();
        });
      }
    });

    function renderSettings() {
      // SERVER
      document.getElementById('serverHost').value = settingsState.server.host || '';
      document.getElementById('serverLogLevel').value = settingsState.server.logLevel || 'INFO';
      document.getElementById('serverFontFolder').value = settingsState.server.additionalFontFolder === false ? 'false' : (settingsState.server.additionalFontFolder || '');
      // PRINTER
      document.getElementById('printerUseCups').checked = settingsState.printer.useCups;
      document.getElementById('printerServer').value = settingsState.printer.server || 'localhost';
      document.getElementById('printerName').value = settingsState.printer.printer || '';
      updateCupsStatus();
      // LABEL - orientation and font size
      document.getElementById('labelDefaultOrientation').value = settingsState.label.defaultOrientation || 'standard';
      document.getElementById('labelDefaultFontSize').value = settingsState.label.defaultFontSize || 70;
      // WEBSITE
      document.getElementById('websiteHtmlTitle').value = settingsState.website.htmlTitle || 'Label Designer';
      document.getElementById('websitePageTitle').value = settingsState.website.pageTitle || 'Label Designer';
      document.getElementById('websitePageHeadline').value = settingsState.website.pageHeadline || 'Design and print labels';

      // Load fonts and label sizes for dropdowns
      loadFonts();
      loadLabelSizes();

      // Render custom sizes list
      renderCustomSizes();
      // Load printers/media list and printer checkboxes
      loadPrinters();

      // Attach change listeners to all form inputs (after rendering)
      attachChangeListeners();
    }

    function attachChangeListeners() {
      // SERVER inputs
      ['serverHost', 'serverLogLevel', 'serverFontFolder'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', markAsChanged);
      });

      // PRINTER inputs
      ['printerUseCups', 'printerServer', 'printerName'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', markAsChanged);
      });

      // LABEL inputs
      ['labelDefaultSize', 'labelDefaultOrientation', 'labelDefaultFontSize', 'labelDefaultFontFamily', 'labelDefaultFontStyle'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', markAsChanged);
      });

      // WEBSITE inputs
      ['websiteHtmlTitle', 'websitePageTitle', 'websitePageHeadline'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', markAsChanged);
      });
    }

    function renderCustomSizes() {
      const list = document.getElementById('customSizesList');
      const sizes = settingsState.printer.labelSizes || {};
      const entries = Object.entries(sizes);
      if (entries.length === 0) { list.innerHTML = '<div class="text-muted">No custom sizes added</div>'; return; }
      let html = '';
      entries.forEach(([key,label]) => {
        html += `<div class="list-group-item" style="display:flex; justify-content:space-between; align-items:center;">
                  <span><strong>${escapeHtml(label)}</strong> <small class="text-muted">(${escapeHtml(key)})</small></span>
                  <div>
                    <button class="btn btn-xs btn-primary" onclick="editCustomSize('${escapeHtmlAttr(key)}')"><span class="glyphicon glyphicon-pencil"></span> Edit</button>
                    <button class="btn btn-xs btn-danger" onclick="removeCustomSize('${escapeHtmlAttr(key)}')"><span class="glyphicon glyphicon-trash"></span> Delete</button>
                  </div>
                 </div>`;
      });
      list.innerHTML = html;
    }

    function addCustomSize() {
      let key = document.getElementById('customSizeKey').value.trim();
      const label = document.getElementById('customSizeLabel').value.trim();
      if (!key || !label) { showStatus('Please enter both size key and label', 'warning'); return; }

      // Automatically prepend "Custom." if not already present
      if (!key.startsWith('Custom.')) {
        key = 'Custom.' + key;
      }

      if (!settingsState.printer.labelSizes) settingsState.printer.labelSizes = {};
      settingsState.printer.labelSizes[key] = label;
      document.getElementById('customSizeKey').value = '';
      document.getElementById('customSizeLabel').value = '';
      renderCustomSizes();
      markAsChanged(); // Mark as unsaved
      // Refresh printers list to include new size in UI
      loadPrinters();
    }

    function editCustomSize(key) {
      if (!settingsState.printer.labelSizes || !(key in settingsState.printer.labelSizes)) return;
      document.getElementById('editSizeKey').value = key;
      document.getElementById('editSizeLabel').value = settingsState.printer.labelSizes[key];
      document.getElementById('editSizeModal').style.display = 'block';
    }

    function saveEditedSize() {
      const key = document.getElementById('editSizeKey').value;
      const label = document.getElementById('editSizeLabel').value.trim();
      if (!label) { showStatus('Please enter a display label', 'warning'); return; }
      if (!settingsState.printer.labelSizes) settingsState.printer.labelSizes = {};
      settingsState.printer.labelSizes[key] = label;
      closeEditModal();
      renderCustomSizes();
      markAsChanged(); // Mark as unsaved
      loadPrinters();
    }

    function closeEditModal() {
      document.getElementById('editSizeModal').style.display = 'none';
    }

    function removeCustomSize(key) {
      if (settingsState.printer.labelSizes && key in settingsState.printer.labelSizes) {
        delete settingsState.printer.labelSizes[key];
        renderCustomSizes();
        markAsChanged(); // Mark as unsaved
        loadPrinters();
      }
    }

    document.getElementById('addCustomSizeBtn').addEventListener('click', addCustomSize);

    // Render printer checkboxes for include/exclude lists
    function renderPrinterCheckboxes(printers) {
      const includeList = document.getElementById('printersIncludeList');
      const excludeList = document.getElementById('printersExcludeList');

      const includeSet = new Set(settingsState.printer.printersInclude || []);
      const excludeSet = new Set(settingsState.printer.printersExclude || []);

      // Create a combined set of all printers (from CUPS + from saved include/exclude lists)
      const allPrinters = new Set(printers);

      // Add any printers from include list that aren't in CUPS (so they can be unchecked)
      (settingsState.printer.printersInclude || []).forEach(p => allPrinters.add(p));

      // Add any printers from exclude list that aren't in CUPS (so they can be unchecked)
      (settingsState.printer.printersExclude || []).forEach(p => allPrinters.add(p));

      const allPrintersList = Array.from(allPrinters).sort();

      // Populate default printer dropdown
      const printerSelect = document.getElementById('printerName');
      const currentPrinter = settingsState.printer.printer || '';

      // Build options HTML starting with CUPS Default
      let optionsHtml = '<option value="">CUPS Default</option>';
      allPrintersList.forEach(printer => {
        const escapedPrinter = escapeHtml(printer);
        const escapedAttr = escapeHtmlAttr(printer);
        const isInCups = printers.includes(printer);
        const suffix = isInCups ? '' : ' (not in CUPS)';
        const selected = printer === currentPrinter ? 'selected' : '';
        optionsHtml += `<option value="${escapedAttr}" ${selected}>${escapedPrinter}${suffix}</option>`;
      });
      printerSelect.innerHTML = optionsHtml;

      if (allPrintersList.length === 0) {
        includeList.innerHTML = '<p class="text-muted">No printers available</p>';
        excludeList.innerHTML = '<p class="text-muted">No printers available</p>';
        return;
      }

      let includeHtml = '';
      let excludeHtml = '';

      allPrintersList.forEach(printer => {
        const escapedPrinter = escapeHtml(printer);
        const escapedAttr = escapeHtmlAttr(printer);
        const isInCups = printers.includes(printer);
        const labelStyle = isInCups ? '' : 'color: #999; font-style: italic;';
        const labelSuffix = isInCups ? '' : ' <small>(not in CUPS)</small>';

        includeHtml += `
          <div class="checkbox" style="margin: 5px 0;">
            <label style="${labelStyle}">
              <input type="checkbox" data-printer="${escapedAttr}" onchange="updatePrinterInclude(this)" ${includeSet.has(printer) ? 'checked' : ''}>
              ${escapedPrinter}${labelSuffix}
            </label>
          </div>
        `;

        excludeHtml += `
          <div class="checkbox" style="margin: 5px 0;">
            <label style="${labelStyle}">
              <input type="checkbox" data-printer="${escapedAttr}" onchange="updatePrinterExclude(this)" ${excludeSet.has(printer) ? 'checked' : ''}>
              ${escapedPrinter}${labelSuffix}
            </label>
          </div>
        `;
      });

      includeList.innerHTML = includeHtml;
      excludeList.innerHTML = excludeHtml;
    }

    function updatePrinterInclude(checkbox) {
      const printer = checkbox.dataset.printer;
      if (!settingsState.printer.printersInclude) settingsState.printer.printersInclude = [];

      if (checkbox.checked) {
        if (!settingsState.printer.printersInclude.includes(printer)) {
          settingsState.printer.printersInclude.push(printer);
        }
      } else {
        const idx = settingsState.printer.printersInclude.indexOf(printer);
        if (idx > -1) {
          settingsState.printer.printersInclude.splice(idx, 1);
        }
      }
      markAsChanged(); // Mark as unsaved
    }

    function updatePrinterExclude(checkbox) {
      const printer = checkbox.dataset.printer;
      if (!settingsState.printer.printersExclude) settingsState.printer.printersExclude = [];

      if (checkbox.checked) {
        if (!settingsState.printer.printersExclude.includes(printer)) {
          settingsState.printer.printersExclude.push(printer);
        }
      } else {
        const idx = settingsState.printer.printersExclude.indexOf(printer);
        if (idx > -1) {
          settingsState.printer.printersExclude.splice(idx, 1);
        }
      }
      markAsChanged(); // Mark as unsaved
    }

    // Load printers and their media sizes
    function loadPrinters(forceRefresh = false) {
      const url = forceRefresh ? '/api/settings/printers?refresh=1' : '/api/settings/printers';
      fetch(url)
        .then(response => response.json())
        .then(data => {
          renderPrinterCheckboxes(data.printers || []);
          renderPrintersList(data);
        })
        .catch(error => { console.error('Error loading printers:', error); showStatus('Failed to load printers: ' + error, 'danger'); });
    }

    // Render the list of printers with their media sizes
    function renderPrintersList(data) {
      const container = document.getElementById('printers-container');
      const printers = data.printers || [];
      let allMediaSizes = data.all_media_sizes || {};

      // Merge in custom sizes (global) for every printer if not already present
      const customSizes = settingsState.printer.labelSizes || {};
      printers.forEach(p => {
        const list = allMediaSizes[p] || [];
        const existingKeys = new Set(list.map(item => item[0]));
        for (const [k,v] of Object.entries(customSizes)) {
          if (!existingKeys.has(k)) list.push([k, v]);
        }
        allMediaSizes[p] = list;
      });

      if (printers.length === 0) { container.innerHTML = '<p class="text-muted">No printers available</p>'; return; }

      let html = '';
      printers.forEach((printer, index) => {
        const enabledForPrinter = settingsState.printer.enabledSizes[printer] || [];
        const mediaSizes = allMediaSizes[printer] || [];
        const disabledCount = mediaSizes.length - enabledForPrinter.length;
        const collapserId = `collapse_${index}`;
        const headingId = `heading_${index}`;

        html += `
          <div class="panel panel-default" style="margin-bottom: 15px;">
            <div class="panel-heading" style="cursor: pointer;" data-toggle="collapse" data-target="#${collapserId}" aria-expanded="false" aria-controls="${collapserId}">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <h5 style="margin: 0; flex: 1;">
                  <span class="glyphicon glyphicon-print" aria-hidden="true"></span>
                  <span class="glyphicon glyphicon-chevron-right" style="font-size: 12px; margin-left: 5px;"></span>
                  ${escapeHtml(printer)}
                </h5>
                <span class="text-muted counter-${escapeHtml(printer)}" style="font-size: 12px; margin-right: 10px;">
                  ${mediaSizes.length > 0 ? `${disabledCount}/${mediaSizes.length} disabled` : 'No sizes'}
                </span>
              </div>
            </div>
            <div id="${collapserId}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="${headingId}">
              <div class="panel-body">
        `;

        if (mediaSizes.length === 0) {
          html += '<p class="text-muted">No media sizes available for this printer</p>';
        } else {
          html += `
            <div style="margin-bottom: 15px;">
              <button class="btn btn-sm btn-success" onclick="enableAllSizes('${escapeHtmlAttr(printer)}')">
                <span class="glyphicon glyphicon-ok-circle" aria-hidden="true"></span> Enable All
              </button>
              <button class="btn btn-sm btn-danger" onclick="disableAllSizes('${escapeHtmlAttr(printer)}')">
                <span class="glyphicon glyphicon-ban-circle" aria-hidden="true"></span> Disable All
              </button>
            </div>
          `;

          html += '<div class="list-group" style="margin-bottom: 10px;">';
          mediaSizes.forEach(size => {
            const sizeKey = size[0];
            const sizeLabel = size[1];
            const isEnabled = enabledForPrinter.includes(sizeKey);
            const checkboxId = `size_${escapeHtml(printer)}_${escapeHtml(sizeKey)}`;

            html += `
              <label class="list-group-item" style="border-radius: 4px; margin-bottom: 5px;">
                <input type="checkbox" id="${checkboxId}"
                       data-printer="${printer}"
                       data-size="${sizeKey}"
                       ${isEnabled ? 'checked' : ''}
                       onchange="updateEnabledSize(this)" />
                <span class="text-success">(Enable)</span> ${escapeHtml(sizeLabel)}
              </label>
            `;
          });
          html += '</div>';
        }

        html += `
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Enable all sizes for a printer
    function enableAllSizes(printer) {
      if (!settingsState.printer.enabledSizes[printer]) settingsState.printer.enabledSizes[printer] = [];
      const checkboxes = document.querySelectorAll(`input[data-printer="${printer}"]`);
      const allSizes = [];
      checkboxes.forEach(cb => { cb.checked = true; allSizes.push(cb.dataset.size); });
      settingsState.printer.enabledSizes[printer] = allSizes;
      updatePrinterCounter(printer);
      markAsChanged(); // Mark as unsaved
    }

    // Disable all sizes for a printer
    function disableAllSizes(printer) {
      if (!settingsState.printer.enabledSizes[printer]) settingsState.printer.enabledSizes[printer] = [];
      const checkboxes = document.querySelectorAll(`input[data-printer="${printer}"]`);
      checkboxes.forEach(cb => { cb.checked = false; });
      settingsState.printer.enabledSizes[printer] = [];
      updatePrinterCounter(printer);
      markAsChanged(); // Mark as unsaved
    }

    // Update enabled sizes when checkbox changes
    function updateEnabledSize(checkbox) {
      const printer = checkbox.dataset.printer;
      const size = checkbox.dataset.size;
      if (!settingsState.printer.enabledSizes[printer]) settingsState.printer.enabledSizes[printer] = [];
      if (checkbox.checked) {
        if (!settingsState.printer.enabledSizes[printer].includes(size)) settingsState.printer.enabledSizes[printer].push(size);
      } else {
        const idx = settingsState.printer.enabledSizes[printer].indexOf(size);
        if (idx > -1) settingsState.printer.enabledSizes[printer].splice(idx, 1);
      }
      updatePrinterCounter(printer);
      markAsChanged(); // Mark as unsaved
    }

    function updatePrinterCounter(printer) {
      const counterElement = document.querySelector(`.counter-${escapeHtml(printer)}`);
      if (counterElement) {
        const checkboxes = document.querySelectorAll(`input[data-printer="${printer}"]`);
        const total = checkboxes.length;
        const enabled = settingsState.printer.enabledSizes[printer] ? settingsState.printer.enabledSizes[printer].length : 0;
        const disabled = total - enabled;
        counterElement.textContent = `${disabled}/${total} disabled`;
      }
    }

    // Update CUPS toggle
    document.getElementById('printerUseCups').addEventListener('change', function() {
      settingsState.printer.useCups = this.checked;
      updateCupsStatus();
    });

    // Reload media sizes from CUPS (no changes to enabled/disabled state)
    document.getElementById('reloadMediaBtn').addEventListener('click', function() {
      loadPrinters(true);
      showStatus('Media sizes reloaded from CUPS', 'info');
    });

    // Update CUPS status message
    function updateCupsStatus() {
      const statusDiv = document.getElementById('cups-status');
      if (settingsState.printer.useCups) {
        statusDiv.className = 'alert alert-success';
        statusDiv.innerHTML = '<strong>✓ CUPS media retrieval is enabled</strong><br>Media sizes will be retrieved from the CUPS print server.';
      } else {
        statusDiv.className = 'alert alert-warning';
        statusDiv.innerHTML = '<strong>✗ CUPS media retrieval is disabled</strong><br>Only configuration-defined media sizes will be used.';
      }
    }

    // Collect settings from UI
    function collectSettings() {
      const fontFolder = document.getElementById('serverFontFolder').value.trim();
      return {
        server: {
          host: document.getElementById('serverHost').value.trim(),
          logLevel: document.getElementById('serverLogLevel').value,
          additionalFontFolder: fontFolder === 'false' ? false : (fontFolder || false)
        },
        printer: {
          useCups: document.getElementById('printerUseCups').checked,
          server: document.getElementById('printerServer').value.trim(),
          printer: document.getElementById('printerName').value.trim(),
          enabledSizes: settingsState.printer.enabledSizes,
          labelSizes: settingsState.printer.labelSizes,
          printersInclude: settingsState.printer.printersInclude || [],
          printersExclude: settingsState.printer.printersExclude || []
        },
        label: {
          defaultSize: document.getElementById('labelDefaultSize').value.trim(),
          defaultOrientation: document.getElementById('labelDefaultOrientation').value,
          defaultFontSize: parseInt(document.getElementById('labelDefaultFontSize').value) || 70,
          defaultFontFamily: document.getElementById('labelDefaultFontFamily').value.trim(),
          defaultFontStyle: document.getElementById('labelDefaultFontStyle').value.trim()
        },
        website: {
          htmlTitle: document.getElementById('websiteHtmlTitle').value.trim(),
          pageTitle: document.getElementById('websitePageTitle').value.trim(),
          pageHeadline: document.getElementById('websitePageHeadline').value.trim()
        }
      };
    }

    // Save settings to the server
    function saveSettings() {
      const payload = collectSettings();
      fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            // Update local state with freshly collected payload
            settingsState = payload;
            markAsSaved(); // Clear unsaved indicator
            showStatus('Settings saved successfully! Some changes may require a restart.', data.has_errors ? 'warning' : 'success');
            // Refresh config errors display
            loadConfigErrors();
            // Reload printers/media and label sizes to reflect any changes
            loadPrinters(true);
            loadLabelSizes();
            // Update in-memory titles immediately for UX
            document.title = settingsState.website.htmlTitle || document.title;
            const pageTitleEl = document.querySelector('.navbar-brand');
            if (pageTitleEl) pageTitleEl.textContent = settingsState.website.pageTitle || pageTitleEl.textContent;
          } else {
            showStatus('Failed to save settings: ' + (data.error || 'Unknown error'), 'danger');
          }
        })
        .catch(err => { console.error('Error saving settings:', err); showStatus('Error saving settings: ' + err, 'danger'); });
    }

    document.getElementById('saveButton').addEventListener('click', saveSettings);
    document.getElementById('saveButton2').addEventListener('click', saveSettings);
    document.getElementById('resetButton').addEventListener('click', loadSettings);
    document.getElementById('resetButton2').addEventListener('click', loadSettings);

    document.getElementById('validateCupsBtn').addEventListener('click', function() {
      const server = document.getElementById('printerServer').value.trim() || 'localhost';
      const statusEl = document.getElementById('cupsValidateStatus');
      statusEl.className = 'text-info';
      statusEl.textContent = 'Validating CUPS server...';
      fetch('/api/settings/cups/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ server })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          statusEl.className = 'text-success';
          const list = (data.printers || []).map(p => escapeHtml(p)).join(', ');
          statusEl.innerHTML = `Connected to <strong>${escapeHtml(server)}</strong>. Printers: ${list || 'none found'}.`;
        } else {
          statusEl.className = 'text-danger';
          statusEl.textContent = 'Validation failed: ' + (data.error || 'Unknown error');
        }
      })
      .catch(err => {
        statusEl.className = 'text-danger';
        statusEl.textContent = 'Validation failed: ' + err;
      });
    });

    function showStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      const alertClass = 'alert alert-' + type;
      statusDiv.className = alertClass;
      statusDiv.innerHTML = message;
      statusDiv.style.display = 'inline-block';
      if (type === 'success') setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
    }

    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    function escapeHtmlAttr(text) {
      return String(text).replace(/"/g, '&quot;').replace(/'/g, '&#x27;');
    }

    function loadConfigErrors() {
      const errorsList = document.getElementById('errorsList');
      if (!errorsList) return; // Not on settings page

      fetch('/api/config-errors')
        .then(r => r.json())
        .then(data => {
          if (data.has_errors && data.errors && data.errors.length > 0) {
            let html = '<ul style="margin-bottom: 0;">';
            data.errors.forEach(error => {
              html += '<li>' + escapeHtml(error) + '</li>';
            });
            html += '</ul>';
            errorsList.innerHTML = html;
          } else {
            // No errors
            const alertDiv = document.querySelector('.alert-danger');
            if (alertDiv) {
              alertDiv.style.display = 'none';
            }
          }
        })
        .catch(err => {
          console.error('Error loading configuration errors:', err);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
      loadSettings();
      loadConfigErrors();
    });
  </script>

  <style>
    .panel-body label { margin-bottom: 0; }
    .list-group-item { padding: 8px 12px; }
    #settingsAccordion .panel-title a { display: block; text-decoration: none; color: white; }
    #settingsAccordion .panel-title a:hover { text-decoration: none; }
    #settingsAccordion .panel-primary .panel-heading { background-color: #337ab7; border-color: #337ab7; }
    #settingsAccordion .panel-info .panel-heading { background-color: #5bc0de; border-color: #5bc0de; }
    #settingsAccordion .panel-success .panel-heading { background-color: #5cb85c; border-color: #5cb85c; }
    #settingsAccordion .panel-warning .panel-heading { background-color: #f0ad4e; border-color: #f0ad4e; }
    #settingsAccordion .panel { margin-bottom: 10px; }
    #statusMessage { display: inline-block; padding: 10px 15px; border-radius: 4px; }
    .help-block { margin-top: 5px; margin-bottom: 0; }
    .form-horizontal .form-group { margin-bottom: 20px; }
  </style>
{% endblock %}

